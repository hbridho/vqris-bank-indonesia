<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>V-QRIS</title>
    <style>
        body {
            font-family: 'Montserrat', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background-color: #E5F4F9;
            color: #333;
        }
        #content {
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            padding: 20px;
            height: 90%;
            width: 90%;
            max-height: 600px;
            max-width: 400px;
            text-align: center;
            justify-content: space-between;
            position: relative;
        }
        .button-container {
            position: absolute;
            top: 50%; /* Center vertically */
            left: 50%;
            transform: translate(-50%, -50%); /* Center horizontally and vertically */
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .button {
            display: inline-block;
            width: 300px; /* Increase width */
            height: 300px; /* Increase height */
            background-color: transparent;
            background-size: cover;
            border: none;
            cursor: pointer;
            margin-top: 10px; /* Adjust margin to control spacing between buttons */
        }
        #generated-img {
            display: none;
            width: auto;
            height: 200px;
            margin-bottom: 20px;
        }
        #text {
            margin-top: 20px;
            font-size: 24px;
            font-weight: bold;
        }
        #speech-text {
            position: absolute;
            top: 10px;
            font-size: 18px;
            font-weight: bold;
            padding: 10px;
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
</head>
<body>
    <div id="content">
        <div id="speech-text"></div>
        <img id="generated-img" src="{{ url_for('static', filename='images/a.png') }}" alt="QR Code">
        <p id="text"></p>
        <div class="button-container">
            <button id="start-btn" class="button" style="background-image: url('{{ url_for('static', filename='images/mic.png') }}');"></button>
            <button id="back-btn" class="button" style="display: none; background-image: url('{{ url_for('static', filename='images/back.png') }}');"></button>
        </div>
    </div>
    <script>
        var recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
        recognition.lang = 'id-ID';
        recognition.interimResults = false;
        recognition.maxAlternatives = 1;

        var currentStep = 0;
        var paymentAmount = '';

        function playAudio(url, callback) {
            var audio = new Audio(url);
            audio.play();
            audio.onended = function() {
                callback();
            };
        }

        function updateSpeechText(text) {
            document.getElementById('speech-text').innerText = text;
        }

        function clearSpeechText() {
            document.getElementById('speech-text').innerText = '';
        }

        function startRecognitionWithCue() {
            playAudio('/static/voice/start_rec.wav', function() {
                startRecognition();
                toggleButtonState(true);
            });
        }

        function startRecognition() {
            recognition.start();
        }

        function toggleButtonState(isRecognizing) {
            var button = document.getElementById('start-btn');
            if (isRecognizing) {
                button.disabled = true;
                button.style.backgroundImage = "url('{{ url_for('static', filename='images/sound_wave.gif') }}')";
            } else {
                button.disabled = false;
                button.style.backgroundImage = "url('{{ url_for('static', filename='images/mic.png') }}')";
            }
        }

        function handleFailedRecognition() {
            updateSpeechText('Input gagal. Coba lagi.');
            playAudio('/tts_failed', function() {
                if (currentStep === 0) {
                    updateSpeechText('Apakah ingin melakukan pembayaran via V-QRIS?');
                    playAudio('/tts_suggest', startRecognitionWithCue);
                } else if (currentStep === 1) {
                    updateSpeechText('Silahkan menyebutkan nominal pembayaran');
                    playAudio('/tts_asking', startRecognitionWithCue);
                } else if (currentStep === 2) {
                    updateSpeechText('Silahkan menyebutkan nominal pembayaran');
                    playAudio('/tts_asking', startRecognitionWithCue);
                }
            });
        }

        function isPositiveResponse(text) {
            const positiveResponses = ["iya", "ya", "yes", "yup", "benar", "betul", "ok", "oke", "baik"];
            return positiveResponses.some(word => text.includes(word));
        }

        function isNegativeResponse(text) {
            const negativeResponses = ["tidak", "ga", "gak", "enggak", "no", "nggak", "bukan"];
            return negativeResponses.some(word => text.includes(word));
        }

        document.getElementById('start-btn').addEventListener('click', () => {
            toggleButtonState(true);  // Disable the button immediately
            updateSpeechText('Apakah ingin melakukan pembayaran via V-QRIS?');
            playAudio('/tts_suggest', startRecognitionWithCue);
        });

        document.getElementById('back-btn').addEventListener('click', () => {
            location.reload();
        });

        recognition.onresult = function(event) {
            var last = event.results.length - 1;
            var text = event.results[last][0].transcript.toLowerCase();

            var button = document.getElementById('start-btn');

            if (currentStep === 0) {
                if (isPositiveResponse(text)) {
                    currentStep++;
                    updateSpeechText('Silahkan menyebutkan nominal pembayaran');
                    playAudio('/tts_asking', startRecognitionWithCue);
                } else {
                    handleFailedRecognition();
                }
            } else if (currentStep === 1) {
                paymentAmount = text;
                $.ajax({
                    url: '/speech_to_text',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ 'text': text }),
                    success: function(response) {
                        if (response.shown_number) {
                            currentStep++;
                            clearSpeechText();
                            playAudio('/audio/' + response.audio, startRecognitionWithCue);
                            document.getElementById('text').textContent = "Rp. " + response.shown_number;
                        } else {
                            handleFailedRecognition();
                        }
                    },
                    error: function(error) {
                        handleFailedRecognition();
                    }
                });
            } else if (currentStep === 2) {
                if (isPositiveResponse(text)) {
                    updateSpeechText('Kode QR berhasil dibuat, Mohon tunjukan kepada kasir');
                    playAudio('/tts_confirmation', function() {
                        document.getElementById('generated-img').style.display = 'block';
                        document.getElementById('text').style.display = 'none';
                        button.style.display = 'none';
                        document.getElementById('back-btn').style.display = 'block';
                        currentStep = 0;  // Reset for next interaction
                    });
                } else if (isNegativeResponse(text)) {
                    updateSpeechText('Silahkan menyebutkan nominal pembayaran');
                    playAudio('/tts_asking', startRecognitionWithCue);
                } else {
                    handleFailedRecognition();
                }
            }
        };

        recognition.onspeechend = function() {
            recognition.stop();
            toggleButtonState(false);
        };

        recognition.onerror = function(event) {
            handleFailedRecognition();
        };
    </script>
</body>
</html>
